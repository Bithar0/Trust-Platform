
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustFirst | The Executive Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Resume Parsing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c', 800: '#292524', 900: '#1c1917' },
                        gold: { 500: '#b45309', 600: '#92400e', 700: '#78350f' }
                    },
                    fontFamily: { serif: ['Playfair Display', 'serif'], sans: ['Inter', 'sans-serif'] },
                    boxShadow: { 'subtle': '0 1px 2px 0 rgba(0, 0, 0, 0.05)', 'card': '0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02)' },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
        
        // PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { background-color: #f5f5f4; color: #1c1917; font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Playfair Display', serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); border: 1px solid #e7e5e4; backdrop-filter: blur(8px); }
        .nav-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background-color: #e7e5e4; border-left-color: #1c1917; color: #000; font-weight: 500; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .circle-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .circle-card:hover { transform: translateY(-4px); border-color: #a8a29e; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
        .circle-card.selected { border-color: #1c1917; background-color: #fafaf9; ring: 1px solid #1c1917; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #44403c; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .action-btn { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; font-weight: 500; color: #57534e; padding: 6px 12px; border-radius: 6px; transition: all 0.2s; }
        .action-btn:hover { background-color: #f5f5f4; color: #1c1917; }
        .reaction-trigger:hover .reaction-dock { display: flex; animation: dockUp 0.2s ease-out forwards; }
        .reaction-dock { display: none; position: absolute; bottom: 100%; left: 0; margin-bottom: 8px; background: white; padding: 4px 8px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e7e5e4; gap: 4px; z-index: 50; }
        @keyframes dockUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .reaction-emoji { font-size: 1.25rem; transition: transform 0.1s; cursor: pointer; padding: 2px; }
        .reaction-emoji:hover { transform: scale(1.3); }
        
        /* Timeline Styles */
        .timeline-item { position: relative; padding-left: 24px; border-left: 2px solid #e7e5e4; padding-bottom: 24px; }
        .timeline-item:last-child { border-left: none; }
        .timeline-dot { position: absolute; left: -5px; top: 0; width: 8px; height: 8px; background-color: #a8a29e; border-radius: 50%; }
        .timeline-item:hover .timeline-dot { background-color: #1c1917; transform: scale(1.2); transition: all 0.2s; }

        /* Trust Score Animation */
        @keyframes scoreFlash { 0% { color: #1c1917; } 50% { color: #16a34a; transform: scale(1.1); } 100% { color: #1c1917; transform: scale(1); } }
        .score-update { animation: scoreFlash 0.5s ease-in-out; }

        /* Autocomplete */
        .autocomplete-items { position: absolute; border: 1px solid #d6d3d1; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; border-radius: 0 0 4px 4px; background-color: white; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .autocomplete-item { padding: 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #f5f5f4; font-size: 0.875rem; }
        .autocomplete-item:hover { background-color: #f5f5f4; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-stone-200 selection:text-black">

    <!-- APP STATE & LOGIC -->
    <script>
        const appState = {
            user: { 
                name: "", role: "", company: "", email: "", bio: "", trustScore: 750, location: "",
                avatarUrl: "",
                experience: [], 
                education: []   
            },
            selectedCircle: null,
            network: [],
            // Defining Circles with specific colors for the profile frame
            circles: [
                { id: 'founder', name: "Founders", desc: "0-1 & Scale-up", icon: "üöÄ", color: "border-amber-500", text: "text-amber-800" },
                { id: 'cxo', name: "CXO Suite", desc: "C-Level Execs", icon: "üíº", color: "border-slate-800", text: "text-slate-900" },
                { id: 'professional', name: "Professionals", desc: "Career Growth", icon: "üëî", color: "border-blue-600", text: "text-blue-700" },
                { id: 'tech', name: "Tech Leaders", desc: "Engineering & AI", icon: "‚ö°", color: "border-cyan-600", text: "text-cyan-700" },
                { id: 'product', name: "Product", desc: "Strategy & UX", icon: "üëÅÔ∏è", color: "border-purple-600", text: "text-purple-700" },
                { id: 'capital', name: "Investors", desc: "VC & PE", icon: "üìà", color: "border-emerald-600", text: "text-emerald-700" },
                { id: 'student', name: "Students", desc: "Future Leaders", icon: "üéì", color: "border-yellow-500", text: "text-yellow-600" },
                { id: 'aspirant', name: "Job Seekers", desc: "Open to Work", icon: "üîç", color: "border-pink-500", text: "text-pink-600" },
                { id: 'retired', name: "Veterans", desc: "Retired Pros", icon: "üéñÔ∏è", color: "border-stone-500", text: "text-stone-600" }
            ],
            briefing: "Today in Founders' Table: Discussion heating up on 'Bootstrapping vs VC in 2025'. 12 Members shared hiring playbooks. 3 new M&A opportunities listed.",
            newsInterests: "Business, Tech, Global Economy",
            notifications: [
                { id: 1, text: "Sarah Jenkins vouched for your recent post.", time: "2h ago", read: false },
                { id: 2, text: "Marcus T. requested to connect.", time: "4h ago", read: false }
            ],
            conversations: [
                { 
                    id: 1, 
                    user: "Elena R.", 
                    role: "CFO at FintechX", 
                    avatar: "ER", 
                    lastMessage: "Do you have a moment to discuss the Q3 metrics?", 
                    time: "10:30 AM",
                    messages: [
                        { sender: "Elena R.", text: "Hi Alex, saw your post about hiring." },
                        { sender: "You", text: "Yes, we are looking for a new VP." },
                        { sender: "Elena R.", text: "Do you have a moment to discuss the Q3 metrics?" }
                    ]
                }
            ],
            activeConversationId: 1,
            connectionTarget: null // Used for the modal
        };

        const mockDatabase = [
            { id: 101, name: "Sarah Jenkins", role: "VP Engineering", company: "Acme Corp", email: "sarah@acme.com", domain: "acme.com", circle: "tech" },
            { id: 102, name: "David Lo", role: "Product Lead", company: "Acme Corp", email: "david@acme.com", domain: "acme.com", circle: "product" },
            { id: 103, name: "Elena R.", role: "CFO", company: "FintechX", email: "elena@fintechx.com", domain: "fintechx.com", circle: "cxo" },
            { id: 104, name: "Marcus T.", role: "Founder", company: "Stealth", email: "marcus@stealth.io", domain: "stealth.io", circle: "founder" },
            { id: 105, name: "Dr. Aris", role: "Chief Scientist", company: "DeepMind", email: "aris@google.com", domain: "google.com", circle: "tech" }
        ];

        // Global Company Database (Simulated)
        const globalCompanies = [
            "Accenture", "Adobe", "Airbnb", "Alphabet (Google)", "Amazon", "American Express", "Apple", "AT&T",
            "Bain & Company", "Bank of America", "Barclays", "Berkshire Hathaway", "BlackRock", "Blackstone", "Bloomberg", "Boeing", "Boston Consulting Group", "BP", "Bridgewater",
            "Cisco", "Citigroup", "Coca-Cola", "Comcast", "Costco",
            "Deloitte", "Disney", "Dropbox",
            "Electronic Arts", "ExxonMobil", "EY",
            "Facebook (Meta)", "FedEx", "Fidelity", "Ford",
            "General Electric", "General Motors", "Goldman Sachs",
            "Home Depot", "Honeywell", "HP", "HSBC",
            "IBM", "Intel", "Intuit",
            "Johnson & Johnson", "JPMorgan Chase",
            "KPMG",
            "LinkedIn", "Lockheed Martin",
            "Mastercard", "McDonald's", "McKinsey & Company", "Microsoft", "Morgan Stanley",
            "Netflix", "Nike", "NVIDIA",
            "Oracle",
            "Palantir", "PayPal", "PepsiCo", "Pfizer", "Procter & Gamble", "PwC",
            "Qualcomm",
            "Salesforce", "Samsung", "SAP", "Sequoia Capital", "Shell", "Shopify", "Siemens", "Sony", "SpaceX", "Spotify", "Starbucks", "Stripe",
            "Target", "Tesla", "TikTok", "Toyota", "Twitter (X)",
            "Uber", "UBS", "Unilever", "UnitedHealth Group", "UPS",
            "Verizon", "Visa", "Volkswagen",
            "Walmart", "Warner Bros. Discovery", "Wells Fargo",
            "Y Combinator",
            // Individual Statuses
            "Student", "Job Seeker", "Freelancer", "Self-Employed", "Independent"
        ];

        const globalDesignations = [
            "CEO", "CTO", "CFO", "COO", "CMO", "CPO", "CIO", "CHRO",
            "President", "Vice President", "Director", "Head of Product", "Head of Engineering", "Head of Sales", "Head of Marketing",
            "Product Manager", "Project Manager", "Program Manager",
            "Software Engineer", "Senior Software Engineer", "Staff Engineer", "Principal Engineer",
            "Data Scientist", "Data Analyst", "Business Analyst",
            "UX Designer", "UI Designer", "Product Designer",
            "Sales Manager", "Account Executive", "Business Development Manager",
            "Marketing Manager", "Content Strategist", "Social Media Manager",
            "HR Manager", "Recruiter", "Talent Acquisition Specialist",
            "Consultant", "Strategy Consultant", "Investment Banker", "Private Equity Associate",
            "Founder", "Co-Founder", "Owner", "Partner", "Managing Director", "Student", "Intern", "Apprentice"
        ];

        const apiKey = ""; 

        async function callGemini(prompt, buttonId) {
            const btn = buttonId ? document.getElementById(buttonId) : null;
            const originalText = btn ? btn.innerHTML : "";
            try {
                if (btn) { btn.disabled = true; btn.innerHTML = `<span class="loader mr-2"></span> Thinking...`; }
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error("Gemini API Error:", error);
                if(buttonId) alert("AI Service temporarily unavailable.");
                return null;
            } finally {
                if(btn) { btn.disabled = false; btn.innerHTML = originalText; }
            }
        }
    </script>

    <!-- VIEW 1: PRESTIGE LANDING -->
    <div id="view-landing" class="absolute inset-0 z-50 bg-stone-900 flex items-center justify-center p-6 transition-transform duration-700 ease-in-out">
        <div class="max-w-5xl w-full grid md:grid-cols-2 gap-12 items-center">
            <div class="space-y-8 text-stone-100">
                <div class="border-l-2 border-gold-600 pl-6">
                    <h1 class="font-serif text-5xl md:text-6xl leading-tight mb-4">Signal.<br><span class="text-stone-500 italic">Not Noise.</span></h1>
                    <p class="text-stone-400 text-lg font-light max-w-md leading-relaxed">
                        The private infrastructure for serious professionals. No vanity metrics. Just vetted peers and high-value discourse.
                    </p>
                </div>
                <div class="space-y-4">
                    <div id="auth-forms" class="bg-white rounded-sm p-1 max-w-sm">
                        <!-- Google Login -->
                        <div class="p-4 pb-0">
                            <button onclick="handleGoogleLogin(this)" class="w-full flex items-center justify-center gap-2 bg-white border border-stone-300 text-stone-700 py-2.5 text-sm font-medium rounded-sm hover:bg-stone-50 transition mb-4 shadow-sm">
                                <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                Continue with Google
                            </button>
                            <div class="relative mb-4">
                                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-stone-200"></div></div>
                                <div class="relative flex justify-center text-[10px] uppercase tracking-wider text-stone-400"><span class="bg-white px-2">Or via OTP</span></div>
                            </div>
                        </div>

                        <!-- OTP Tabs -->
                        <div class="flex border-b border-stone-100 mx-4">
                            <button onclick="toggleAuth('email')" id="tab-email" class="flex-1 py-2 text-xs font-bold text-stone-900 border-b-2 border-stone-900 uppercase tracking-wide">Gmail OTP</button>
                            <button onclick="toggleAuth('wa')" id="tab-wa" class="flex-1 py-2 text-xs font-bold text-stone-400 border-b-2 border-transparent hover:text-stone-600 uppercase tracking-wide">WhatsApp</button>
                        </div>
                        <div class="p-4">
                            <input type="text" id="auth-input" class="w-full border-b border-stone-300 py-2 text-stone-900 outline-none focus:border-stone-900 placeholder-stone-400 bg-transparent text-sm" placeholder="name@gmail.com">
                            <button id="btn-auth-action" onclick="handleSignup()" class="w-full mt-4 bg-stone-900 text-white py-3 text-sm font-medium rounded-sm hover:bg-stone-800 transition">Send Gmail OTP</button>
                        </div>
                    </div>
                    <p class="text-stone-600 text-xs">By applying, you agree to our <span class="underline">Chatham House Rule</span> policy.</p>
                </div>
            </div>
            <div class="hidden md:block h-[500px] bg-stone-800 rounded-sm overflow-hidden relative opacity-80 border border-stone-700">
                <!-- Abstract UI mock -->
                <div class="absolute top-10 left-10 right-10 bottom-0 bg-stone-100 rounded-t-lg p-6 shadow-2xl">
                    <div class="h-4 w-32 bg-stone-300 rounded mb-6"></div>
                    <div class="space-y-4">
                        <div class="h-24 bg-white border border-stone-200 rounded p-4 flex gap-4">
                            <div class="w-12 h-12 rounded-full bg-stone-200"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-3 w-3/4 bg-stone-200 rounded"></div>
                                <div class="h-3 w-1/2 bg-stone-200 rounded"></div>
                            </div>
                        </div>
                        <div class="h-24 bg-white border border-stone-200 rounded p-4 flex gap-4 opacity-50">
                            <div class="w-12 h-12 rounded-full bg-stone-200"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-3 w-3/4 bg-stone-200 rounded"></div>
                                <div class="h-3 w-1/2 bg-stone-200 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW 2: EXECUTIVE PROFILE BUILDER -->
    <div id="view-profile" class="absolute inset-0 z-40 bg-stone-50 flex items-center justify-center p-6 hidden overflow-y-auto">
        <div class="max-w-2xl w-full bg-white p-10 shadow-xl border border-stone-200">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="font-serif text-3xl text-stone-900">Executive Dossier</h2>
                    <p class="text-stone-500 text-sm mt-1">This is how you will be presented to the circle.</p>
                </div>
                <div class="text-xs font-mono text-stone-400">STEP 1 OF 2</div>
            </div>

            <!-- Pre-fill from Resume -->
            <div class="mb-8 p-4 bg-stone-50 border border-dashed border-stone-300 rounded flex justify-between items-center">
                <div>
                    <p class="text-sm font-bold text-stone-700">Quick Start</p>
                    <p class="text-xs text-stone-500">Upload your resume to auto-fill details.</p>
                </div>
                <label class="cursor-pointer bg-white border border-stone-300 text-stone-700 text-xs py-2 px-3 rounded hover:bg-stone-50 transition">
                    <span>Upload PDF / DOCX</span>
                    <input type="file" class="hidden" accept=".pdf,.docx,.txt" onchange="handleResumeUpload(this, true)">
                </label>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Avatar Col -->
                <div class="col-span-1 flex flex-col items-center text-center">
                    <div class="relative group">
                        <div id="p-avatar-preview" onclick="document.getElementById('p-avatar-upload').click()" class="w-32 h-32 bg-stone-100 rounded-full border-2 border-dashed border-stone-300 flex items-center justify-center text-3xl text-stone-400 mb-3 cursor-pointer hover:border-stone-500 hover:bg-stone-200 transition overflow-hidden bg-cover bg-center">
                            <span id="p-avatar-placeholder">üì∑</span>
                        </div>
                        <input type="file" id="p-avatar-upload" accept="image/png, image/jpeg, image/gif, image/webp, image/bmp, image/tiff" class="hidden" onchange="previewAvatar(this, 'p-avatar-preview')">
                    </div>
                    <p class="text-xs font-medium text-stone-900">Profile Image</p>
                    <p class="text-[10px] text-stone-500 mt-1">JPG, PNG, GIF, WEBP, BMP, TIFF</p>
                </div>

                <!-- Form Col -->
                <div class="col-span-2 space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-stone-500 uppercase tracking-wider mb-1">First Name</label>
                            <input type="text" id="p-fname" class="w-full border-b border-stone-300 py-1 text-sm focus:border-stone-900 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-500 uppercase tracking-wider mb-1">Last Name</label>
                            <input type="text" id="p-lname" class="w-full border-b border-stone-300 py-1 text-sm focus:border-stone-900 outline-none">
                        </div>
                    </div>
                    
                    <div class="relative">
                        <label class="block text-[10px] font-bold text-stone-500 uppercase tracking-wider mb-1">Current Headline</label>
                        <input type="text" id="p-role" class="w-full border-b border-stone-300 py-1 text-sm focus:border-stone-900 outline-none" placeholder="e.g. VP Engineering at FinTech Co" oninput="searchDesignations(this, 'p-role-results')">
                        <div id="p-role-results" class="autocomplete-items hidden"></div>
                    </div>

                    <div class="relative">
                        <label class="block text-[10px] font-bold text-stone-500 uppercase tracking-wider mb-1">Company / Organization</label>
                        <input type="text" id="p-company" class="w-full border-b border-stone-300 py-1 text-sm focus:border-stone-900 outline-none" oninput="searchCompanies(this, 'p-company-results')" onblur="validateCompany(this)">
                        <div id="p-company-results" class="autocomplete-items hidden"></div>
                        <p id="p-company-error" class="hidden text-[10px] text-red-600 mt-1">Please select a valid verified company.</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-1">
                            <label class="block text-[10px] font-bold text-stone-500 uppercase tracking-wider">Professional Bio</label>
                            <button onclick="polishBio()" id="btn-polish" class="text-[10px] text-gold-600 font-medium hover:underline flex items-center gap-1">‚ú® AI Refine</button>
                        </div>
                        <textarea id="p-bio" rows="3" class="w-full bg-stone-50 border border-stone-200 rounded p-2 text-sm focus:border-stone-400 outline-none resize-none" placeholder="Briefly describe your expertise and current focus..."></textarea>
                    </div>

                    <div class="pt-4 flex justify-end">
                        <button onclick="saveProfile()" class="bg-stone-900 text-white px-8 py-3 text-sm font-medium rounded-sm hover:bg-stone-800 transition shadow-lg">Proceed to Circle Selection &rarr;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW 3: CIRCLE SELECTION -->
    <div id="view-circles" class="absolute inset-0 z-40 bg-stone-100 flex flex-col items-center justify-center p-6 hidden overflow-y-auto">
        <div class="max-w-6xl w-full">
            <div class="text-center mb-12">
                <h2 class="font-serif text-4xl text-stone-900 mb-3">Choose Your Boardroom</h2>
                <p class="text-stone-500 text-sm max-w-lg mx-auto">Select your primary professional domain. This determines your peer group, access level, and daily intelligence briefing.</p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-8" id="circles-container">
                <!-- JS Populated -->
            </div>

            <div id="circle-confirm" class="fixed bottom-10 left-0 right-0 flex justify-center hidden pointer-events-none">
                <button onclick="enterDashboard()" class="pointer-events-auto bg-stone-900 text-white px-10 py-4 text-sm font-medium rounded-full shadow-2xl hover:bg-stone-800 transition transform hover:-translate-y-1 flex items-center gap-3">
                    Enter <span id="conf-circle-name" class="font-serif italic">Selected</span> Circle
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- VIEW 4: MAIN DASHBOARD (THE BOARDROOM) -->
    <div id="view-dashboard" class="flex h-full w-full hidden bg-stone-100">
        <!-- Sidebar Navigation (Same as before) -->
        <aside class="w-64 bg-white border-r border-stone-200 flex flex-col z-20">
            <div class="p-6 border-b border-stone-100">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-stone-900 text-white flex items-center justify-center font-serif font-bold text-lg rounded-sm">T</div>
                    <span class="font-serif font-bold text-lg text-stone-900 tracking-tight">TrustFirst</span>
                </div>
            </div>
            
            <div class="flex-1 py-6 px-3 space-y-1">
                <button id="btn-nav-feed" onclick="setTab('feed')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-md text-stone-600 text-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
                    The Boardroom
                </button>
                <button id="btn-nav-messages" onclick="setTab('messages')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-stone-600 text-sm group">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    Messages
                    <span class="ml-auto bg-stone-200 text-stone-700 text-[10px] px-2 py-0.5 rounded-full font-bold group-[.active]:bg-stone-900 group-[.active]:text-white">2</span>
                </button>
                <button id="btn-nav-network" onclick="setTab('network')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-stone-600 text-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    My Network <span id="network-count" class="ml-auto text-[10px] bg-stone-100 text-stone-600 px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button id="btn-nav-profile" onclick="setTab('profile')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-md text-stone-600 text-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Executive Profile
                </button>
            </div>

            <div class="p-6 border-t border-stone-100 bg-stone-50">
                <p class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">My Trust Score</p>
                <div class="flex items-end gap-2 mb-1">
                    <span class="text-3xl font-serif text-stone-900 score-val" id="dash-score">750</span>
                    <span class="text-xs text-green-600 font-medium mb-1">High Integrity</span>
                </div>
                <div class="w-full bg-stone-200 h-1 rounded-full overflow-hidden">
                    <div class="bg-stone-800 h-full w-[75%]" id="score-bar"></div>
                </div>
            </div>
        </aside>

        <!-- CENTER: CONTENT AREA -->
        <main class="flex-1 overflow-y-auto relative scroll-smooth" id="main-content">
            <!-- Header -->
            <header class="sticky top-0 bg-white/90 backdrop-blur border-b border-stone-200 px-8 py-4 z-10 flex justify-between items-center">
                <div>
                    <h2 class="font-serif text-xl text-stone-900" id="dash-circle-name">Founders' Table</h2>
                    <p class="text-xs text-stone-500">Private Circle ‚Ä¢ 142 Members</p>
                </div>
                <div class="flex gap-4 items-center">
                    <!-- Notifications -->
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="p-2 text-stone-400 hover:text-stone-900 relative transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <span class="absolute top-1 right-1 w-2 h-2 bg-red-600 rounded-full ring-2 ring-white"></span>
                        </button>
                        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white border border-stone-200 shadow-xl rounded-lg z-50 overflow-hidden">
                            <div class="bg-stone-50 px-4 py-2 border-b border-stone-100 text-xs font-bold text-stone-500 uppercase tracking-wider">Notifications</div>
                            <div id="notif-list" class="max-h-64 overflow-y-auto">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <button onclick="openPostModal('article')" class="text-sm font-medium text-white bg-stone-900 hover:bg-stone-800 px-4 py-2 rounded-sm shadow-sm flex items-center gap-2">
                        <span>+</span> Create Post
                    </button>
                </div>
            </header>

            <!-- Dashboard Content Container -->
            
            <!-- FEED TAB -->
            <div id="tab-feed" class="p-8 max-w-3xl mx-auto space-y-8 pb-20">
                
                <!-- Mobile Live Wire (Visible lg:hidden) -->
                <div class="lg:hidden mb-8 bg-white border-l-4 border-red-600 shadow-sm rounded-r p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-serif text-lg text-stone-900 flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-600 rounded-full animate-pulse-slow"></span>
                            Live Executive Wire
                        </h3>
                        <button onclick="openNewsConfig()" class="text-[10px] text-stone-400 uppercase font-bold">Config</button>
                    </div>
                    <div id="mobile-news-container" class="space-y-3">
                        <div class="text-center py-4 text-stone-400 text-xs italic">Loading wire...</div>
                    </div>
                </div>

                <!-- Daily Briefing (AI Generated) -->
                <div class="bg-stone-800 text-stone-200 p-6 rounded-lg shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl font-serif">"</div>
                    <h3 class="font-serif text-lg text-white mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> 
                        Morning Intelligence
                    </h3>
                    <p class="text-sm leading-relaxed text-stone-300" id="briefing-text">Loading intelligence...</p>
                </div>

                <!-- Feed -->
                <div id="feed-stream" class="space-y-6">
                    <!-- Dynamic Posts -->
                </div>
            </div>

            <!-- MESSAGES TAB -->
            <div id="tab-messages" class="hidden h-[calc(100vh-64px)] flex flex-col md:flex-row bg-white">
                <!-- Conversation List -->
                <div class="w-full md:w-80 border-r border-stone-200 bg-stone-50 overflow-y-auto">
                    <div class="p-4 border-b border-stone-200 sticky top-0 bg-stone-50 z-10">
                         <h3 class="font-serif text-xl text-stone-900">Messages</h3>
                    </div>
                    <div id="conversation-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <!-- Chat Window -->
                <div class="flex-1 flex flex-col bg-white">
                    <div class="p-4 border-b border-stone-100 flex items-center gap-3">
                        <div class="w-10 h-10 bg-stone-200 rounded-full flex items-center justify-center text-sm font-bold text-stone-600" id="chat-header-avatar"></div>
                        <div>
                            <h4 class="font-bold text-stone-900" id="chat-header-name">Select a conversation</h4>
                            <p class="text-xs text-stone-500" id="chat-header-role"></p>
                        </div>
                    </div>
                    
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-stone-50/30">
                        <!-- Messages go here -->
                        <div class="flex justify-center h-full items-center text-stone-400 text-sm">Select a conversation to start chatting</div>
                    </div>

                    <div class="p-4 border-t border-stone-200 bg-white">
                        <div class="flex gap-2">
                            <input type="text" id="chat-input" class="flex-1 border border-stone-300 rounded p-2 text-sm outline-none focus:border-stone-900" placeholder="Type a message...">
                            <button onclick="sendMessage()" class="bg-stone-900 text-white px-4 py-2 text-sm rounded hover:bg-stone-800">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NETWORK TAB -->
            <div id="tab-network" class="hidden p-8 max-w-4xl mx-auto pb-20">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h3 class="font-serif text-2xl text-stone-900">My Professional Network</h3>
                        <p class="text-stone-500 text-sm mt-1">Vetted peers and verified colleagues.</p>
                    </div>
                    <div class="relative">
                        <input type="text" placeholder="Search connections..." class="pl-8 pr-4 py-2 border border-stone-200 rounded-full text-sm w-64 focus:border-stone-400 outline-none">
                        <svg class="w-4 h-4 text-stone-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="network-grid">
                    <!-- Network Cards Populated Here -->
                </div>
                
                <div id="empty-network" class="hidden text-center py-12 border-2 border-dashed border-stone-200 rounded-lg">
                    <p class="text-stone-400 mb-2">No connections yet.</p>
                    <p class="text-stone-500 text-xs">Explore the sidebar for suggestions or wait for colleagues to join.</p>
                </div>
            </div>

            <!-- PROFILE TAB -->
            <div id="tab-profile" class="hidden p-8 max-w-4xl mx-auto pb-20">
                <div class="bg-white border border-stone-200 rounded-lg p-8 shadow-sm mb-8 flex flex-col md:flex-row items-center md:items-start gap-8">
                    <div class="w-32 h-32 bg-stone-200 rounded-full flex items-center justify-center text-4xl font-serif font-bold text-stone-600 flex-shrink-0 bg-cover bg-center overflow-hidden border-4 border-stone-200" id="dash-profile-initials"></div>
                    <div class="flex-1 text-center md:text-left">
                        <h2 class="font-serif text-3xl text-stone-900 mb-2" id="dash-profile-name">Alex V.</h2>
                        <p class="text-lg text-stone-600" id="dash-profile-role">Executive</p>
                        <p class="text-sm text-stone-500" id="dash-profile-company">Company</p>
                        <p class="text-sm text-stone-500 mt-4 leading-relaxed max-w-lg" id="dash-profile-bio">Bio loading...</p>
                        <div class="mt-6 flex gap-3 justify-center md:justify-start">
                            <button onclick="toggleProfileEdit()" class="px-4 py-2 border border-stone-300 text-stone-700 text-sm rounded hover:bg-stone-50">Edit Profile</button>
                            <button class="px-4 py-2 bg-stone-900 text-white text-sm rounded hover:bg-stone-800">Share Profile</button>
                        </div>
                    </div>
                </div>

                <!-- TIMELINE SECTION -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white border border-stone-200 rounded-lg p-6 shadow-sm">
                            <h3 class="font-serif text-xl text-stone-900 mb-4 border-b border-stone-100 pb-2">Experience</h3>
                            <div id="profile-exp-list" class="space-y-4"></div>
                        </div>
                        <div class="bg-white border border-stone-200 rounded-lg p-6 shadow-sm">
                            <h3 class="font-serif text-xl text-stone-900 mb-4 border-b border-stone-100 pb-2">Education</h3>
                            <div id="profile-edu-list" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white border border-stone-200 rounded-lg p-6 shadow-sm">
                            <h3 class="font-serif text-lg text-stone-900 mb-3">Endorsements</h3>
                            <div class="flex flex-wrap gap-2">
                                <span class="text-xs bg-stone-100 text-stone-600 px-3 py-1 rounded-full">Leadership (12)</span>
                                <span class="text-xs bg-stone-100 text-stone-600 px-3 py-1 rounded-full">Strategy (8)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EDIT PROFILE FORM (Hidden by default) -->
                <div id="profile-edit-form" class="hidden fixed inset-0 z-50 bg-stone-900/50 backdrop-blur-sm flex justify-end">
                    <div class="w-full max-w-lg bg-white h-full shadow-2xl p-8 overflow-y-auto animate-slide-in">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-serif text-xl text-stone-900">Update Profile</h3>
                            <button onclick="toggleProfileEdit()" class="text-stone-400 hover:text-stone-900 text-2xl">&times;</button>
                        </div>

                        <!-- RESUME PARSER -->
                        <div class="mb-8 p-6 bg-stone-50 border border-dashed border-stone-300 rounded-lg text-center">
                            <div class="mb-2 text-2xl">üìÑ</div>
                            <h4 class="font-medium text-stone-900 mb-1">Auto-fill from Resume</h4>
                            <p class="text-xs text-stone-500 mb-4">Supports PDF, DOCX, TXT. Extracts experience & education.</p>
                            <div class="flex flex-col gap-3 max-w-sm mx-auto">
                                <label class="cursor-pointer bg-white hover:bg-stone-100 text-stone-600 text-xs py-2 px-4 rounded border border-stone-300 transition shadow-sm font-medium">
                                    <span>Upload Resume File</span>
                                    <input type="file" id="resume-upload-main" class="hidden" accept=".pdf,.docx,.txt" onchange="handleResumeUpload(this, false)">
                                </label>
                                <div id="parsing-status" class="hidden text-xs text-gold-600 animate-pulse font-medium">Parsing document...</div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- Avatar Upload in Edit -->
                            <div class="flex justify-center mb-4">
                                 <div class="relative group">
                                    <div id="edit-avatar-preview" onclick="document.getElementById('edit-avatar-upload').click()" class="w-24 h-24 bg-stone-100 rounded-full border-2 border-dashed border-stone-300 flex items-center justify-center text-2xl text-stone-400 cursor-pointer hover:border-stone-500 hover:bg-stone-200 transition overflow-hidden bg-cover bg-center">
                                        <span id="edit-avatar-placeholder">üì∑</span>
                                    </div>
                                    <input type="file" id="edit-avatar-upload" accept="image/png, image/jpeg, image/gif, image/webp, image/bmp, image/tiff" class="hidden" onchange="previewAvatar(this, 'edit-avatar-preview')">
                                    <p class="text-[10px] text-center text-stone-500 mt-1">Change Photo</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-stone-500 uppercase">Name</label><input type="text" id="edit-name" class="w-full p-2 border border-stone-300 rounded text-sm mt-1"></div>
                                <div><label class="text-xs font-bold text-stone-500 uppercase">Role</label><input type="text" id="edit-role" class="w-full p-2 border border-stone-300 rounded text-sm mt-1" oninput="searchDesignations(this, 'edit-role-results')">
                                    <div id="edit-role-results" class="autocomplete-items hidden"></div>
                                </div>
                            </div>
                            <div class="relative">
                                <label class="text-xs font-bold text-stone-500 uppercase">Company</label>
                                <input type="text" id="edit-company" class="w-full p-2 border border-stone-300 rounded text-sm mt-1" oninput="searchCompanies(this, 'edit-company-results')" onblur="validateCompany(this, 'edit-company-error')">
                                <div id="edit-company-results" class="autocomplete-items hidden"></div>
                                <p id="edit-company-error" class="hidden text-[10px] text-red-600 mt-1">Please select a valid verified company.</p>
                            </div>
                            <div><label class="text-xs font-bold text-stone-500 uppercase">Bio</label><textarea id="edit-bio" rows="4" class="w-full p-2 border border-stone-300 rounded text-sm mt-1"></textarea></div>
                            
                            <div class="border-t border-stone-100 pt-4">
                                <p class="text-xs font-bold text-stone-500 uppercase mb-2">Parsed Experience (JSON)</p>
                                <textarea id="edit-exp-json" rows="6" class="w-full p-2 border border-stone-300 rounded text-xs font-mono text-stone-600 bg-stone-50" placeholder="[]"></textarea>
                                <p class="text-[10px] text-stone-400 mt-1">AI populates this. You can edit the JSON structure manually if needed.</p>
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end gap-3">
                            <button onclick="toggleProfileEdit()" class="px-4 py-2 text-sm text-stone-600">Cancel</button>
                            <button onclick="saveProfileChanges()" class="px-6 py-2 bg-stone-900 text-white text-sm rounded hover:bg-stone-800">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- RIGHT: INTELLIGENCE SIDEBAR -->
        <aside class="w-80 bg-stone-50 border-l border-stone-200 hidden lg:block p-6 overflow-y-auto">
            <!-- LIVE EXECUTIVE WIRE WIDGET (DESKTOP) -->
            <div class="mb-10 p-4 bg-white border-l-4 border-red-600 shadow-sm rounded-r">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-serif text-lg text-stone-900 flex items-center gap-2">
                        <span class="w-2 h-2 bg-red-600 rounded-full animate-pulse-slow"></span>
                        Live Wire
                    </h3>
                    <button onclick="openNewsConfig()" class="text-[10px] text-stone-400 hover:text-stone-900 uppercase font-bold tracking-wider">Config</button>
                </div>
                
                <div id="news-container" class="space-y-4">
                    <div class="text-center py-8 text-stone-400 text-xs italic">Connecting to wire...</div>
                </div>
                
                <div class="mt-3 text-[10px] text-stone-400 text-right" id="news-timer">Updated just now</div>
            </div>

            <h3 class="font-serif text-lg text-stone-900 mb-6">Circle Intelligence</h3>
            
            <!-- Trending Topics -->
            <div class="mb-8">
                <p class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-3">Trending Themes</p>
                <div class="space-y-2">
                    <div class="p-3 bg-white border border-stone-200 rounded-sm hover:border-stone-400 cursor-pointer transition">
                        <span class="text-xs font-medium text-stone-900">#AI_Governance</span>
                        <p class="text-[10px] text-stone-500 mt-1">12 Discussions this week</p>
                    </div>
                    <div class="p-3 bg-white border border-stone-200 rounded-sm hover:border-stone-400 cursor-pointer transition">
                        <span class="text-xs font-medium text-stone-900">#SeriesB_Crunch</span>
                        <p class="text-[10px] text-stone-500 mt-1">8 Discussions this week</p>
                    </div>
                </div>
            </div>

            <!-- Recommended Peers -->
            <div>
                <p class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-3">Suggested Peers</p>
                <div class="space-y-3" id="peer-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </aside>
    </div>

    <!-- MODAL: NEWS CONFIG -->
    <div id="modal-news" class="fixed inset-0 z-50 bg-stone-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded shadow-xl p-6">
            <h3 class="font-serif text-xl text-stone-900 mb-4">Wire Intelligence Settings</h3>
            <p class="text-sm text-stone-500 mb-4">Define the topics for your AI-curated news stream.</p>
            <input type="text" id="news-interests-input" class="w-full border p-2 text-sm rounded mb-4" placeholder="e.g. Fintech, Crypto, Macroeconomics">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('modal-news').classList.add('hidden')" class="px-4 py-2 text-sm text-stone-600">Cancel</button>
                <button onclick="saveNewsConfig()" class="px-4 py-2 bg-stone-900 text-white text-sm rounded">Update Stream</button>
            </div>
        </div>
    </div>

    <!-- MODAL: POST CREATOR -->
    <div id="modal-post" class="fixed inset-0 z-50 bg-stone-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-stone-100 flex justify-between items-center">
                <h3 class="font-serif text-xl text-stone-900">Create Post</h3>
                <button onclick="closeModal()" class="text-stone-400 hover:text-stone-900 text-xl">&times;</button>
            </div>
            
            <!-- Post Types -->
            <div class="flex bg-stone-50 border-b border-stone-200 text-xs font-medium uppercase tracking-wide">
                <button onclick="setType('memo')" id="type-memo" class="flex-1 py-3 text-stone-900 border-b-2 border-stone-900">Article</button>
                <button onclick="setType('job')" id="type-job" class="flex-1 py-3 text-stone-500 border-b-2 border-transparent hover:bg-stone-100">Post Job</button>
                <button onclick="setType('question')" id="type-question" class="flex-1 py-3 text-stone-500 border-b-2 border-transparent hover:bg-stone-100">Question</button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 space-y-4">
                <input type="text" id="post-title" class="w-full text-2xl font-serif border-none outline-none placeholder-stone-300" placeholder="Headline">
                
                <!-- Dynamic Fields -->
                <div id="job-fields" class="hidden grid grid-cols-2 gap-4 bg-stone-50 p-4 rounded border border-stone-200">
                    <input type="text" id="job-comp" class="bg-transparent border-b border-stone-300 text-sm py-1 outline-none" placeholder="Company">
                    <input type="text" id="job-loc" class="bg-transparent border-b border-stone-300 text-sm py-1 outline-none" placeholder="Location">
                    <input type="text" id="job-role-field" class="bg-transparent border-b border-stone-300 text-sm py-1 outline-none col-span-2" placeholder="Role Title">
                </div>

                <textarea id="post-body" class="w-full text-stone-700 leading-relaxed border-none outline-none resize-none h-48" placeholder="Share your insight or context..."></textarea>
                
                <div class="flex justify-between items-center pt-2">
                    <button onclick="aiEnhance()" id="btn-enhance" class="text-xs text-gold-600 hover:text-gold-700 flex items-center gap-1">‚ú® AI Polish Tone</button>
                    <!-- NEW EXPAND BUTTON -->
                    <button onclick="aiExpand()" id="btn-expand" class="text-xs text-stone-500 hover:text-stone-900 flex items-center gap-1">‚ö° Expand Idea</button>
                    <span class="text-xs text-stone-400" id="char-count">0 chars</span>
                </div>
            </div>

            <div class="px-6 py-4 bg-stone-50 border-t border-stone-200 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-sm text-stone-600 hover:text-stone-900">Cancel</button>
                <button onclick="publishPost()" id="btn-publish" class="px-6 py-2 bg-stone-900 text-white text-sm font-medium rounded-sm hover:bg-stone-800">Publish</button>
            </div>
        </div>
    </div>

    <!-- MODAL: SMART CONNECT -->
    <div id="modal-connect" class="fixed inset-0 z-50 bg-stone-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded shadow-xl p-6">
            <h3 class="font-serif text-xl text-stone-900 mb-2">Request Introduction</h3>
            <p class="text-sm text-stone-500 mb-4">Draft a personalized note to connect.</p>
            
            <textarea id="connect-message" rows="4" class="w-full border border-stone-300 rounded p-2 text-sm mb-4 resize-none focus:border-stone-500 outline-none" placeholder="Hi Sarah, I'd love to connect regarding..."></textarea>
            
            <div class="flex justify-between items-center">
                <button onclick="aiDraftConnection()" id="btn-ai-connect" class="text-xs text-gold-600 hover:text-gold-700 font-medium">‚ú® AI Draft Intro</button>
                <div class="flex gap-2">
                    <button onclick="closeConnectModal()" class="px-4 py-2 text-sm text-stone-600">Cancel</button>
                    <button onclick="sendConnectionRequest()" class="px-4 py-2 bg-stone-900 text-white text-sm rounded">Send Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- NAVIGATION & AUTH ---
        function toggleAuth(mode) {
            const emailBtn = document.getElementById('tab-email'); const waBtn = document.getElementById('tab-wa');
            const input = document.getElementById('auth-input');
            const btn = document.getElementById('btn-auth-action');
            if(mode === 'email') {
                emailBtn.className = "flex-1 py-2 text-xs font-bold text-stone-900 border-b-2 border-stone-900 uppercase tracking-wide";
                waBtn.className = "flex-1 py-2 text-xs font-bold text-stone-400 border-b-2 border-transparent hover:text-stone-600 uppercase tracking-wide";
                input.placeholder = "name@gmail.com";
                btn.innerText = "Send Gmail OTP";
                btn.className = "w-full mt-4 bg-stone-900 text-white py-3 text-sm font-medium rounded-sm hover:bg-stone-800 transition";
            } else {
                waBtn.className = "flex-1 py-2 text-xs font-bold text-stone-900 border-b-2 border-stone-900 uppercase tracking-wide";
                emailBtn.className = "flex-1 py-2 text-xs font-bold text-stone-400 border-b-2 border-transparent hover:text-stone-600 uppercase tracking-wide";
                input.placeholder = "+1 (555) 000-0000";
                btn.innerText = "Send WhatsApp OTP";
                btn.className = "w-full mt-4 bg-green-600 text-white py-3 text-sm font-medium rounded-sm hover:bg-green-700 transition";
            }
        }

        function handleSignup() {
            const val = document.getElementById('auth-input').value;
            if(!val) return alert("Please enter your details.");
            appState.user.email = val;
            transition('view-landing', 'view-profile');
        }

        function handleGoogleLogin(btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="loader border-stone-400 border-t-stone-700 mr-2"></span> Connecting...`;
            
            setTimeout(() => {
                appState.user.email = "alex.executive@gmail.com";
                // Pre-fill profile name if we assume Google provides it
                const fname = document.getElementById('p-fname');
                const lname = document.getElementById('p-lname');
                if(fname) fname.value = "Alex";
                if(lname) lname.value = "V.";
                
                transition('view-landing', 'view-profile');
                btn.innerHTML = originalText;
            }, 800);
        }

        // --- DASHBOARD NAVIGATION ---
        function setTab(tabId) {
            // Update Sidebar UI
            ['feed', 'network', 'profile', 'messages'].forEach(t => {
                const btn = document.getElementById(`btn-nav-${t}`);
                if(btn) {
                    if(t === tabId) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
                
                const tab = document.getElementById(`tab-${t}`);
                if(tab) {
                    if(t === tabId) tab.classList.remove('hidden');
                    else tab.classList.add('hidden');
                }
            });
            
            // If switching to specialized tabs, trigger their render logic
            if (tabId === 'network') renderNetwork();
            if (tabId === 'profile') renderProfileTab();
            if (tabId === 'messages') renderMessagesTab();
        }

        // --- NOTIFICATIONS & MESSAGES ---
        function toggleNotifications() {
            const drop = document.getElementById('notification-dropdown');
            drop.classList.toggle('hidden');
            
            const list = document.getElementById('notif-list');
            list.innerHTML = appState.notifications.map(n => `
                <div class="px-4 py-3 border-b border-stone-50 hover:bg-stone-50 cursor-pointer">
                    <p class="text-sm text-stone-800">${n.text}</p>
                    <p class="text-[10px] text-stone-400 mt-1">${n.time}</p>
                </div>
            `).join('');
        }

        function renderMessagesTab() {
            const list = document.getElementById('conversation-list');
            list.innerHTML = appState.conversations.map(c => `
                <div onclick="openConversation(${c.id})" class="p-4 border-b border-stone-100 hover:bg-white cursor-pointer transition ${c.id === appState.activeConversationId ? 'bg-white border-l-4 border-l-stone-900' : ''}">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="text-sm font-bold text-stone-900">${c.user}</h4>
                        <span class="text-[10px] text-stone-400">${c.time}</span>
                    </div>
                    <p class="text-xs text-stone-500 truncate">${c.lastMessage}</p>
                </div>
            `).join('');
            
            openConversation(appState.activeConversationId);
        }

        function openConversation(id) {
            appState.activeConversationId = id;
            const conv = appState.conversations.find(c => c.id === id);
            if(!conv) return;

            // Update Header
            document.getElementById('chat-header-avatar').innerText = conv.avatar;
            document.getElementById('chat-header-name').innerText = conv.user;
            document.getElementById('chat-header-role').innerText = conv.role;

            // Render Messages
            const container = document.getElementById('chat-messages');
            container.innerHTML = conv.messages.map(m => `
                <div class="flex flex-col ${m.sender === 'You' ? 'items-end' : 'items-start'}">
                    <div class="max-w-[70%] px-4 py-2 rounded-lg text-sm ${m.sender === 'You' ? 'bg-stone-900 text-white rounded-br-none' : 'bg-white border border-stone-200 text-stone-800 rounded-bl-none shadow-sm'}">
                        ${m.text}
                    </div>
                </div>
            `).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
            
            // Re-render list to highlight active
            const list = document.getElementById('conversation-list');
            Array.from(list.children).forEach((child, index) => {
                const c = appState.conversations[index];
                if (c.id === id) {
                    child.classList.add('bg-white', 'border-l-4', 'border-l-stone-900');
                } else {
                    child.classList.remove('bg-white', 'border-l-4', 'border-l-stone-900');
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if(!text) return;
            
            const conv = appState.conversations.find(c => c.id === appState.activeConversationId);
            conv.messages.push({ sender: 'You', text: text });
            conv.lastMessage = text;
            conv.time = "Just now";
            
            input.value = "";
            renderMessagesTab(); // Refresh list to show new last message
            openConversation(appState.activeConversationId); // Refresh chat view
        }

        // --- NEW CHAT FROM NETWORK ---
        function startChat(name, role, avatar) {
            // Check if conversation exists
            let existingConv = appState.conversations.find(c => c.user === name);
            
            if (existingConv) {
                appState.activeConversationId = existingConv.id;
            } else {
                // Create new conversation
                const newId = appState.conversations.length + 1;
                const initials = name.split(' ').map(n=>n[0]).join('');
                const newConv = {
                    id: newId,
                    user: name,
                    role: role,
                    avatar: initials,
                    lastMessage: "Start of conversation",
                    time: "Now",
                    messages: []
                };
                appState.conversations.unshift(newConv);
                appState.activeConversationId = newId;
            }
            
            setTab('messages');
        }

        // --- SMART CONNECT MODAL LOGIC ---
        function connect(id) {
            const person = mockDatabase.find(u => u.id === id);
            if (!person) return;
            appState.connectionTarget = person;
            document.getElementById('modal-connect').classList.remove('hidden');
            document.getElementById('connect-message').value = ""; // Clear previous
        }

        function closeConnectModal() {
            document.getElementById('modal-connect').classList.add('hidden');
            appState.connectionTarget = null;
        }

        async function aiDraftConnection() {
            if (!appState.connectionTarget) return;
            const target = appState.connectionTarget;
            const user = appState.user;
            
            const prompt = `Draft a warm, professional connection request from ${user.name} (${user.role} at ${user.company}) to ${target.name} (${target.role} at ${target.company}). Keep it under 50 words.`;
            
            const result = await callGemini(prompt, 'btn-ai-connect');
            if(result) document.getElementById('connect-message').value = result;
        }

        function sendConnectionRequest() {
            const person = appState.connectionTarget;
            if (person && !appState.network.find(n => n.id === person.id)) {
                appState.network.push(person);
                renderNetwork(); updateNetworkCount(); renderSuggestions();
                alert(`Request sent to ${person.name}`);
            }
            closeConnectModal();
        }


        // --- IMAGE & AUTOCOMPLETE LOGIC ---
        function previewAvatar(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appState.user.avatarUrl = e.target.result;
                    const preview = document.getElementById(previewId);
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.querySelector('span').style.display = 'none'; // Hide placeholder icon
                    
                    // Update main profile page avatar if editing
                    if (previewId === 'edit-avatar-preview') {
                        updateProfilePageAvatar(e.target.result);
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateProfilePageAvatar(url) {
            const el = document.getElementById('dash-profile-initials');
            if(el) {
                el.innerText = "";
                el.style.backgroundImage = `url(${url})`;
            }
        }

        function searchCompanies(input, resultsId) {
            const val = input.value.toLowerCase();
            const resultsDiv = document.getElementById(resultsId);
            
            if (!val || val.length < 3) {
                resultsDiv.innerHTML = '';
                resultsDiv.classList.add('hidden');
                return;
            }

            const matches = globalCompanies.filter(c => c.toLowerCase().includes(val));
            
            if (matches.length > 0) {
                resultsDiv.innerHTML = matches.map(c => 
                    `<div class="autocomplete-item" onclick="selectCompany('${c}', '${input.id}', '${resultsId}')">${c}</div>`
                ).join('');
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('hidden');
            }
        }

        function selectCompany(companyName, inputId, resultsId) {
            document.getElementById(inputId).value = companyName;
            document.getElementById(resultsId).classList.add('hidden');
            validateCompany(document.getElementById(inputId), inputId === 'p-company' ? 'p-company-error' : 'edit-company-error');
        }
        
        function searchDesignations(input, resultsId) {
            const val = input.value.toLowerCase();
            const resultsDiv = document.getElementById(resultsId);
            
            if (!val || val.length < 2) {
                resultsDiv.innerHTML = '';
                resultsDiv.classList.add('hidden');
                return;
            }

            const matches = globalDesignations.filter(d => d.toLowerCase().includes(val));
            
            if (matches.length > 0) {
                resultsDiv.innerHTML = matches.map(d => 
                    `<div class="autocomplete-item" onclick="selectDesignation('${d}', '${input.id}', '${resultsId}')">${d}</div>`
                ).join('');
                resultsDiv.classList.remove('hidden');
            } else {
                resultsDiv.classList.add('hidden');
            }
        }

        function selectDesignation(designationName, inputId, resultsId) {
            document.getElementById(inputId).value = designationName;
            document.getElementById(resultsId).classList.add('hidden');
        }
        
        function validateCompany(input, errorId = 'p-company-error') {
            const val = input.value;
            const errorEl = document.getElementById(errorId);
            
            if (!val) {
                errorEl.classList.add('hidden');
                return true;
            }

            // Strict check
            const isValid = globalCompanies.includes(val);
            
            if (!isValid) {
                errorEl.classList.remove('hidden');
                input.classList.add('border-red-500');
                input.classList.remove('border-stone-300');
                return false;
            } else {
                errorEl.classList.add('hidden');
                input.classList.remove('border-red-500');
                input.classList.add('border-stone-300');
                return true;
            }
        }

        // Close autocomplete if clicked outside
        document.addEventListener('click', function(e) {
            if (!e.target.matches('input[id$="company"]') && !e.target.matches('input[id$="role"]')) {
                document.querySelectorAll('.autocomplete-items').forEach(el => el.classList.add('hidden'));
            }
        });


        // --- TRUST SCORE LOGIC ---
        function updateTrustScore(points) {
            appState.user.trustScore += points;
            const scoreEl = document.getElementById('dash-score');
            const barEl = document.getElementById('score-bar');
            
            scoreEl.innerText = appState.user.trustScore;
            scoreEl.classList.remove('score-update'); // Reset animation
            void scoreEl.offsetWidth; // Trigger reflow
            scoreEl.classList.add('score-update');
            
            // Update bar width (assuming max 1000)
            const percent = Math.min((appState.user.trustScore / 1000) * 100, 100);
            barEl.style.width = `${percent}%`;
        }

        // --- PROFILE & RESUME PARSING ---
        async function polishBio() {
            const raw = document.getElementById('p-bio').value;
            const role = document.getElementById('p-role').value;
            if(!raw) return alert("Write a draft first.");
            const refined = await callGemini(`Rewrite this professional bio to be executive, impactful and concise. Role: ${role}. Draft: "${raw}"`, 'btn-polish');
            if(refined) document.getElementById('p-bio').value = refined;
        }

        function saveProfile() {
            const fname = document.getElementById('p-fname').value;
            const lname = document.getElementById('p-lname').value;
            const companyInput = document.getElementById('p-company');
            
            if(!fname) return alert("Name is required.");
            
            // Validate Company before saving
            if (!validateCompany(companyInput)) {
                alert("Please select a valid company from the list.");
                return;
            }
            
            appState.user.name = `${fname} ${lname}`;
            appState.user.role = document.getElementById('p-role').value;
            appState.user.company = companyInput.value;
            appState.user.bio = document.getElementById('p-bio').value;
            
            updateTrustScore(50); // +50 for profile completion
            
            // Render Circles
            const container = document.getElementById('circles-container');
            container.innerHTML = appState.circles.map(c => `
                <div onclick="selectCircle('${c.id}')" id="c-${c.id}" class="circle-card bg-white p-6 rounded-lg border border-stone-200 cursor-pointer text-center relative">
                    <div class="text-4xl mb-4">${c.icon}</div>
                    <h3 class="font-serif text-xl text-stone-900 mb-2">${c.name}</h3>
                    <p class="text-xs text-stone-500 leading-relaxed">${c.desc}</p>
                    <div class="absolute top-3 right-3 w-2 h-2 bg-stone-900 rounded-full opacity-0 transition-opacity" id="check-${c.id}"></div>
                </div>
            `).join('');
            
            transition('view-profile', 'view-circles');
        }

        function renderProfileTab() {
            document.getElementById('dash-profile-name').innerText = appState.user.name;
            document.getElementById('dash-profile-role').innerText = appState.user.role;
            document.getElementById('dash-profile-company').innerText = appState.user.company;
            document.getElementById('dash-profile-bio').innerText = appState.user.bio || "No bio yet.";
            
            // Set Avatar
            const avatarEl = document.getElementById('dash-profile-initials');
            if (appState.user.avatarUrl) {
                avatarEl.innerText = "";
                avatarEl.style.backgroundImage = `url(${appState.user.avatarUrl})`;
                // Add the frame color based on selected circle
                if (appState.selectedCircle) {
                    avatarEl.className = `w-32 h-32 rounded-full flex items-center justify-center text-4xl font-serif font-bold text-stone-600 flex-shrink-0 bg-cover bg-center overflow-hidden border-4 ${appState.selectedCircle.color}`;
                }
            } else {
                avatarEl.style.backgroundImage = 'none';
                avatarEl.innerText = appState.user.name.split(' ').map(n=>n[0]).join('');
                if (appState.selectedCircle) {
                    avatarEl.className = `w-32 h-32 rounded-full flex items-center justify-center text-4xl font-serif font-bold ${appState.selectedCircle.text} flex-shrink-0 bg-stone-200 overflow-hidden border-4 ${appState.selectedCircle.color}`;
                }
            }

            // Render Experience
            const expList = document.getElementById('profile-exp-list');
            if (appState.user.experience && appState.user.experience.length > 0) {
                expList.innerHTML = appState.user.experience.map(e => `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <h4 class="text-sm font-bold text-stone-900">${e.title}</h4>
                        <p class="text-xs text-stone-600 font-medium">${e.company} ‚Ä¢ ${e.period}</p>
                        <p class="text-xs text-stone-500 mt-1">${e.summary || ''}</p>
                    </div>
                `).join('');
            } else {
                expList.innerHTML = '<p class="text-stone-400 text-sm italic">No experience listed.</p>';
            }

            // Render Education
            const eduList = document.getElementById('profile-edu-list');
            if (appState.user.education && appState.user.education.length > 0) {
                eduList.innerHTML = appState.user.education.map(e => `
                    <div class="mb-3 last:mb-0">
                        <h4 class="text-sm font-bold text-stone-900">${e.institution}</h4>
                        <p class="text-xs text-stone-600">${e.degree} ‚Ä¢ ${e.year}</p>
                    </div>
                `).join('');
            } else {
                eduList.innerHTML = '<p class="text-stone-400 text-sm italic">No education listed.</p>';
            }
        }

        function toggleProfileEdit() {
            document.getElementById('profile-edit-form').classList.toggle('hidden');
            // Pre-fill
            if(!document.getElementById('profile-edit-form').classList.contains('hidden')) {
                document.getElementById('edit-name').value = appState.user.name;
                document.getElementById('edit-role').value = appState.user.role;
                document.getElementById('edit-company').value = appState.user.company;
                document.getElementById('edit-bio').value = appState.user.bio;
                document.getElementById('edit-exp-json').value = JSON.stringify(appState.user.experience || [], null, 2);
                
                // Show avatar preview if exists
                if(appState.user.avatarUrl) {
                    const preview = document.getElementById('edit-avatar-preview');
                    preview.style.backgroundImage = `url(${appState.user.avatarUrl})`;
                    preview.querySelector('span').style.display = 'none';
                }
            }
        }

        async function handleResumeUpload(input, isInitialSetup) {
            const file = input.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('parsing-status');
            if(statusDiv) statusDiv.classList.remove('hidden');

            let text = "";
            try {
                if (file.name.endsWith('.pdf')) {
                    text = await extractTextFromPDF(file);
                } else if (file.name.endsWith('.docx')) {
                    text = await extractTextFromDOCX(file);
                } else {
                    // Text file
                    text = await file.text();
                }
                
                await parseResumeText(text, isInitialSetup);
            } catch (e) {
                console.error(e);
                alert("Error reading file. Please copy-paste text instead.");
            } finally {
                if(statusDiv) statusDiv.classList.add('hidden');
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                fullText += textContent.items.map(item => item.str).join(" ") + "\n";
            }
            return fullText;
        }

        async function extractTextFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
            return result.value;
        }

        async function parseResumeText(text, isInitialSetup) {
            if(!text) return;
            const prompt = `Extract structured data from this resume. Return strictly valid JSON: 
            {
              "name": "Full Name",
              "role": "Current Job Title",
              "company": "Current Company Name",
              "bio": "A professional summary (max 30 words)",
              "experience": [ {"title": "Job Title", "company": "Company Name", "period": "Year-Year", "summary": "Short 1-line description"} ],
              "education": [ {"degree": "Degree Name", "institution": "School Name", "year": "Year"} ]
            }
            Text: ${text.substring(0, 3000)}`;
            
            const result = await callGemini(prompt, null); // No button ID needed for file upload flow
            
            if(result) {
                try {
                    const cleanJson = result.replace(/^```json\s*/, "").replace(/\s*```$/, "");
                    const data = JSON.parse(cleanJson);
                    
                    if (isInitialSetup) {
                        document.getElementById('p-fname').value = data.name ? data.name.split(' ')[0] : "";
                        document.getElementById('p-lname').value = data.name ? data.name.split(' ').slice(1).join(' ') : "";
                        document.getElementById('p-role').value = data.role || "";
                        document.getElementById('p-company').value = data.company || "";
                        document.getElementById('p-bio').value = data.bio || "";
                        // Store complex data directly in state for later
                        appState.user.experience = data.experience || [];
                        appState.user.education = data.education || [];
                    } else {
                        // Editing mode
                        document.getElementById('edit-name').value = data.name || "";
                        document.getElementById('edit-role').value = data.role || "";
                        document.getElementById('edit-company').value = data.company || "";
                        document.getElementById('edit-bio').value = data.bio || "";
                        document.getElementById('edit-exp-json').value = JSON.stringify(data.experience || [], null, 2);
                        // Also update education silently in state as we don't have a JSON edit field for it in this simple view
                        if(data.education) appState.user.education = data.education;
                    }
                    
                    alert("Resume parsed successfully!");
                } catch(e) {
                    console.error(e);
                    alert("AI processed the resume but returned invalid data format.");
                }
            }
        }

        function saveProfileChanges() {
            appState.user.name = document.getElementById('edit-name').value;
            appState.user.role = document.getElementById('edit-role').value;
            const companyInput = document.getElementById('edit-company');
            appState.user.company = companyInput.value;
            appState.user.bio = document.getElementById('edit-bio').value;

             // Validate Company before saving
             if (!validateCompany(companyInput, 'edit-company-error')) {
                alert("Please select a valid company from the list.");
                return;
            }
            
            try {
                const exp = JSON.parse(document.getElementById('edit-exp-json').value);
                appState.user.experience = exp;
            } catch(e) {
                alert("Invalid Experience JSON format.");
                return;
            }
            
            renderProfileTab();
            toggleProfileEdit();
        }

        // --- CIRCLE SELECTION ---
        function selectCircle(id) {
            document.querySelectorAll('.circle-card').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('[id^="check-"]').forEach(el => el.classList.remove('opacity-100'));
            
            document.getElementById(`c-${id}`).classList.add('selected');
            document.getElementById(`check-${id}`).classList.add('opacity-100');
            
            appState.selectedCircle = appState.circles.find(c => c.id === id);
            document.getElementById('circle-confirm').classList.remove('hidden');
            document.getElementById('conf-circle-name').innerText = appState.selectedCircle.name;
        }

        function enterDashboard() {
            document.getElementById('dash-circle-name').innerText = appState.selectedCircle.name;
            document.getElementById('briefing-text').innerText = appState.briefing;
            
            document.getElementById('dash-profile-name').innerText = appState.user.name;
            document.getElementById('dash-profile-role').innerText = `${appState.user.role}, ${appState.user.company}`;
            document.getElementById('dash-profile-initials').innerText = appState.user.name.split(' ').map(n=>n[0]).join('');

            autoConnectColleagues();

            // Seed Feed with Articles
            const feed = document.getElementById('feed-stream');
            feed.innerHTML = ''; 
            seedBoardroomContent(); // NEW FUNCTION
            
            renderSuggestions();
            startNewsWire();

            transition('view-circles', 'view-dashboard');
        }

        // --- FEED POPULATION ---
        function seedBoardroomContent() {
            // 1. System Welcome (Privacy Protocols)
            addFeedItem("System", "Moderator", "Welcome to the Boardroom", "You have been vetted and approved. This circle adheres to strict privacy protocols. Share insights, not sales pitches.", "memo", "System");

            // 2. Self Article
            addFeedItem(appState.user.name, appState.user.role, "My Thoughts on Market Shifts", "I've been observing some interesting trends in our sector...", "memo", "You");

            // 3. Network Article (1st Degree)
            addFeedItem("Sarah Jenkins", "VP Engineering", "Scaling Teams Remotely", "We successfully onboarded 50 engineers this quarter. Here is our playbook...", "memo", "1st");

            // 4. Extended Network (2nd Degree)
            addFeedItem("Michael Chen", "Product Strategy", "The Future of PLG", "Product-led growth isn't dead, but the metrics are changing...", "memo", "2nd");
        }

        function addFeedItem(name, role, title, body, type, badgeLabel) {
            const id = Date.now() + Math.random(); 
            const initials = name.split(' ').map(n=>n[0]).join('');
            
            let tag = ""; 
            if(type === 'job') tag = `<span class="bg-stone-200 text-stone-700 text-[10px] px-2 py-0.5 rounded uppercase font-bold tracking-wide">Hiring</span>`; 
            if(type === 'question') tag = `<span class="bg-amber-100 text-amber-800 text-[10px] px-2 py-0.5 rounded uppercase font-bold tracking-wide">Question</span>`;
            
            // Relationship Badge Logic
            let relBadge = "";
            if (badgeLabel) {
                let badgeColor = "bg-stone-100 text-stone-500";
                if (badgeLabel === "You") badgeColor = "bg-stone-800 text-white";
                if (badgeLabel === "1st") badgeColor = "bg-green-100 text-green-700";
                if (badgeLabel === "2nd") badgeColor = "bg-blue-50 text-blue-600";
                
                relBadge = `<span class="${badgeColor} text-[9px] px-1.5 py-0.5 rounded ml-2 font-bold uppercase tracking-wider border border-stone-200">${badgeLabel}</span>`;
            }

            const html = `
            <article class="bg-white border border-stone-200 rounded-lg p-6 shadow-sm fade-in relative group">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-stone-800 text-white flex items-center justify-center text-xs font-bold font-serif">${initials}</div>
                        <div>
                            <div class="flex items-center">
                                <p class="text-sm font-bold text-stone-900">${name}</p>
                                ${relBadge}
                            </div>
                            <p class="text-[10px] text-stone-500 uppercase tracking-wide">${role}</p>
                        </div>
                    </div>
                    ${tag}
                </div>
                
                <h4 class="font-serif text-xl text-stone-900 mb-3 leading-tight">${title}</h4>
                <div class="text-stone-600 text-sm leading-relaxed whitespace-pre-wrap font-sans">${body}</div>
                
                <div class="mt-6 pt-4 border-t border-stone-100 flex items-center gap-6">
                    <div class="relative reaction-trigger">
                        <button class="action-btn" id="btn-react-${id}">üëç Vouch</button>
                        <div class="reaction-dock">
                            <span class="reaction-emoji" onclick="react('${id}', 'üëç')">üëç</span>
                            <span class="reaction-emoji" onclick="react('${id}', 'üí°')">üí°</span>
                            <span class="reaction-emoji" onclick="react('${id}', 'üéØ')">üéØ</span>
                            <span class="reaction-emoji" onclick="react('${id}', 'ü§ù')">ü§ù</span>
                        </div>
                    </div>
                    <button class="action-btn" onclick="toggleComments('${id}')">üí¨ Discuss</button>
                    <button class="action-btn ml-auto" onclick="alert('Post reported.')">üö©</button>
                </div>

                <div id="comments-${id}" class="hidden mt-4 bg-stone-50 p-4 rounded border border-stone-100">
                    <div class="flex gap-2">
                        <input type="text" id="inp-com-${id}" class="flex-1 bg-white border border-stone-300 rounded px-3 py-1 text-sm outline-none" placeholder="Add a professional perspective...">
                        <button onclick="aiComment('${id}')" id="btn-ai-${id}" class="text-xs bg-white border border-stone-300 px-3 rounded hover:bg-stone-100">‚ú®</button>
                        <button onclick="addComment('${id}')" class="text-xs bg-stone-900 text-white px-3 rounded">Post</button>
                    </div>
                    <div id="list-com-${id}" class="mt-3 space-y-2"></div>
                </div>
            </article>`;
            
            const feed = document.getElementById('feed-stream');
            feed.insertAdjacentHTML('afterbegin', html);
        }

        // --- NETWORK LOGIC ---
        function autoConnectColleagues() {
            const email = appState.user.email;
            if (!email.includes('@')) return;
            const domain = email.split('@')[1];
            const colleagues = mockDatabase.filter(u => u.domain === domain && u.email !== email);
            if (colleagues.length > 0) {
                appState.network = [...appState.network, ...colleagues];
                alert(`We found ${colleagues.length} colleagues from ${domain} and added them to your network.`);
                renderNetwork(); updateNetworkCount();
            }
        }

        function connect(id) {
            const person = mockDatabase.find(u => u.id === id);
            if (person && !appState.network.find(n => n.id === id)) {
                appState.network.push(person);
                renderNetwork(); updateNetworkCount(); renderSuggestions();
                alert(`Connected with ${person.name}`);
            }
        }

        function renderNetwork() {
            const grid = document.getElementById('network-grid');
            const emptyState = document.getElementById('empty-network');
            if (appState.network.length === 0) { grid.innerHTML = ''; emptyState.classList.remove('hidden'); return; }
            emptyState.classList.add('hidden');
            grid.innerHTML = appState.network.map(p => `
                <div class="bg-white p-4 rounded-lg border border-stone-200 shadow-sm flex items-center gap-4">
                    <div class="w-12 h-12 bg-stone-200 rounded-full flex items-center justify-center text-sm font-bold text-stone-600">${p.name.split(' ').map(n=>n[0]).join('')}</div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-stone-900 text-sm truncate">${p.name}</h4>
                        <p class="text-xs text-stone-500 truncate">${p.role} at ${p.company}</p>
                        <p class="text-[10px] text-stone-400 mt-1">${p.domain === appState.user.email.split('@')[1] ? 'üè¢ Colleague' : 'ü§ù Network'}</p>
                    </div>
                    <button class="text-stone-400 hover:text-stone-900" title="Message" onclick="startChat('${p.name}', '${p.role}', '${p.name.split(' ').map(n=>n[0]).join('')}')">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        function renderSuggestions() {
            const suggestions = mockDatabase.filter(u => !appState.network.find(n => n.id === u.id) && u.email !== appState.user.email).slice(0, 3);
            document.getElementById('peer-list').innerHTML = suggestions.map(p => `<div class="flex items-center gap-3 p-2 hover:bg-stone-100 rounded cursor-pointer group"><div class="w-8 h-8 bg-stone-200 rounded-full flex items-center justify-center text-xs font-bold text-stone-600">${p.name.split(' ').map(n=>n[0]).join('')}</div><div class="flex-1"><p class="text-xs font-bold text-stone-900">${p.name}</p><p class="text-[10px] text-stone-500 truncate w-32">${p.role} at ${p.company}</p></div><button onclick="connect(${p.id})" class="text-[10px] text-stone-500 hover:text-stone-900 border border-stone-200 px-2 py-1 rounded bg-white hover:bg-stone-50 transition">Connect</button></div>`).join('');
        }

        function updateNetworkCount() {
            const count = appState.network.length;
            const badge = document.getElementById('network-count');
            badge.innerText = count; badge.classList.remove('hidden');
        }

        // --- NEWS WIRE LOGIC ---
        function startNewsWire() {
            refreshNews();
            setInterval(refreshNews, 900000);
            startTimerCountdown();
        }

        async function refreshNews() {
            const render = (html) => {
                ['news-container', 'mobile-news-container'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.innerHTML = html;
                });
            };
            
            render(`<div class="text-center py-4"><span class="loader"></span></div>`);
            
            const interests = appState.newsInterests;
            const url = `https://api.rss2json.com/v1/api.json?rss_url=https://news.google.com/rss/search?q=${encodeURIComponent(interests + ' business')}&hl=en-US&gl=US&ceid=US:en`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if(data.items && data.items.length > 0) {
                    const headlines = data.items.slice(0, 10).map(i => i.title).join("\n");
                    const prompt = `Act as an executive editor. Filter out clickbait and noise. Select the top 3 most credible, high-impact market/business updates from these headlines. Summarize them into concise bullet points (max 10 words). \n\n${headlines}`;
                    const summary = await callGemini(prompt, null);
                    
                    if(summary) {
                        const bullets = summary.split('\n').filter(l => l.trim().length > 0).slice(0,3);
                        render(bullets.map(b => `<div class="flex gap-2 items-start group"><span class="text-gold-600 mt-1.5 text-[8px] flex-shrink-0">‚óè</span><p class="text-xs text-stone-600 leading-snug group-hover:text-stone-900 transition">${b.replace(/^-|\*/g, '').trim()}</p></div>`).join(''));
                    } else {
                        render(generateRawNewsHTML(data.items.slice(0,3)));
                    }
                } else {
                    render(`<div class="text-xs text-stone-400 text-center">No wire updates.</div>`);
                }
            } catch(e) {
                render(getSimulatedNews());
            }
            resetTimer();
        }

        function generateRawNewsHTML(items) {
            return items.map(item => `<div class="flex gap-2 items-start"><span class="text-gold-600 mt-1.5 text-[8px] flex-shrink-0">‚óè</span><a href="${item.link}" target="_blank" class="text-xs text-stone-600 leading-snug hover:text-stone-900 truncate block w-full">${item.title}</a></div>`).join('');
        }

        function getSimulatedNews() {
            return `<div class="flex gap-2 items-start group"><span class="text-gold-600 mt-1.5 text-[8px] flex-shrink-0">‚óè</span><p class="text-xs text-stone-600 leading-snug group-hover:text-stone-900">Fed signals potential rate cuts in Q3.</p></div><div class="flex gap-2 items-start group"><span class="text-gold-600 mt-1.5 text-[8px] flex-shrink-0">‚óè</span><p class="text-xs text-stone-600 leading-snug group-hover:text-stone-900">Tech sector rallies on new AI breakthroughs.</p></div><div class="flex gap-2 items-start group"><span class="text-gold-600 mt-1.5 text-[8px] flex-shrink-0">‚óè</span><p class="text-xs text-stone-600 leading-snug group-hover:text-stone-900">Global supply chains stabilizing post-disruption.</p></div>`;
        }

        let nextUpdate = Date.now() + 900000;
        function resetTimer() {
            nextUpdate = Date.now() + 900000;
            const timer = document.getElementById('news-timer');
            if(timer) timer.innerText = "Just updated";
        }

        function startTimerCountdown() {
            setInterval(() => {
                const left = Math.max(0, Math.ceil((nextUpdate - Date.now()) / 60000));
                const timer = document.getElementById('news-timer');
                if (timer && left > 0 && left < 15) timer.innerText = `Refreshes in ${left}m`;
            }, 60000);
        }

        function openNewsConfig() { document.getElementById('news-interests-input').value = appState.newsInterests; document.getElementById('modal-news').classList.remove('hidden'); }
        function saveNewsConfig() { const val = document.getElementById('news-interests-input').value; if(val) { appState.newsInterests = val; document.getElementById('modal-news').classList.add('hidden'); refreshNews(); } }

        // --- FEED & POSTING ---
        let postType = 'memo';
        function openPostModal(type) { document.getElementById('modal-post').classList.remove('hidden'); setType(type || 'memo'); }
        function closeModal() { document.getElementById('modal-post').classList.add('hidden'); }
        
        function setType(t) {
            postType = t;
            ['memo', 'question', 'job'].forEach(k => {
                const el = document.getElementById(`type-${k}`);
                if(k === t) { el.classList.add('text-stone-900', 'border-stone-900'); el.classList.remove('text-stone-500', 'border-transparent'); }
                else { el.classList.remove('text-stone-900', 'border-stone-900'); el.classList.add('text-stone-500', 'border-transparent'); }
            });
            const jobFields = document.getElementById('job-fields'); const titleInput = document.getElementById('post-title');
            if(t === 'job') { jobFields.classList.remove('hidden'); titleInput.placeholder = "Role Title (e.g. Chief of Staff)"; } 
            else if (t === 'question') { jobFields.classList.add('hidden'); titleInput.placeholder = "Strategic Question (e.g. How are you handling X?)"; } 
            else { jobFields.classList.add('hidden'); titleInput.placeholder = "Memo Headline"; }
        }

        async function aiEnhance() { const body = document.getElementById('post-body').value; if(!body) return; const res = await callGemini(`Improve professional tone. Text: "${body}"`, 'btn-enhance'); if(res) document.getElementById('post-body').value = res; }
        
        // AI Expand Logic
        async function aiExpand() {
            const body = document.getElementById('post-body').value;
            if(!body) return alert("Write a draft bullet point first.");
            
            const prompt = `Expand this rough idea into a structured executive memo (max 3 short paragraphs). Include: 1. Core Problem, 2. Analysis/Insight, 3. Strategic Implication. Tone: Professional, direct. Text: "${body}"`;
            
            const res = await callGemini(prompt, 'btn-expand');
            if(res) document.getElementById('post-body').value = res;
        }

        async function aiSpark() { const res = await callGemini(`Generate a trending discussion topic for ${appState.selectedCircle.name}. JSON {title, body}`, 'btn-spark'); try { const json = JSON.parse(res.replace(/```json|```/g, '')); openPostModal('question'); document.getElementById('post-title').value = json.title; document.getElementById('post-body').value = json.body; } catch(e) {} }

        async function publishPost() {
            const title = document.getElementById('post-title').value; const body = document.getElementById('post-body').value; if(!title) return;
            const btn = document.getElementById('btn-publish'); const oldTxt = btn.innerText; btn.disabled = true; btn.innerText = "Vetting...";
            const safety = await callGemini(`Check abuse. Text: "${title} ${body}". JSON {safe: boolean, reason: string}`, null);
            try { 
                const cleanJson = safety.replace(/^```json\s*/, "").replace(/\s*```$/, "");
                const check = JSON.parse(cleanJson);
                if(!check.safe) { 
                    alert("Blocked: " + check.reason); 
                    btn.disabled = false; 
                    btn.innerText = oldTxt; 
                    return; 
                } 
            } catch(e) { console.log(e); }
            btn.disabled = false; btn.innerText = oldTxt; 
            
            // Add post with 'You' badge and update trust score
            addFeedItem(appState.user.name, appState.user.role, title, body, postType, "You"); 
            updateTrustScore(10);
            
            closeModal();
            document.getElementById('post-title').value = ""; document.getElementById('post-body').value = "";
        }

        // --- INTERACTIONS ---
        function react(id, emoji) { 
            document.getElementById(`btn-react-${id}`).innerHTML = `${emoji} Vouched`; 
            document.getElementById(`btn-react-${id}`).classList.add('text-gold-600');
            // Reaction gives minimal points, or maybe to the author? Simulating user engagement points for now.
            updateTrustScore(2);
        }
        function toggleComments(id) { document.getElementById(`comments-${id}`).classList.toggle('hidden'); }
        async function aiComment(id) { const res = await callGemini("Draft professional comment. Max 1 sentence.", `btn-ai-${id}`); if(res) document.getElementById(`inp-com-${id}`).value = res; }
        function addComment(id) { 
            const txt = document.getElementById(`inp-com-${id}`).value; if(!txt) return; 
            const html = `<div class="flex gap-2 text-xs"><span class="font-bold text-stone-900">${appState.user.name}</span><span class="text-stone-600">${txt}</span></div>`; 
            document.getElementById(`list-com-${id}`).insertAdjacentHTML('beforeend', html); 
            document.getElementById(`inp-com-${id}`).value = ""; 
            updateTrustScore(5);
        }

        // --- UTILS ---
        function transition(from, to) { const f = document.getElementById(from); const t = document.getElementById(to); f.style.opacity = '0'; setTimeout(() => { f.classList.add('hidden'); t.classList.remove('hidden'); void t.offsetWidth; t.classList.add('fade-in'); }, 500); }
    </script>
</body>
</html>
